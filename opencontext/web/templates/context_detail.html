
{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">上下文详情</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="/contexts" class="btn btn-sm btn-outline-secondary">返回列表</a>
            <button class="btn btn-sm btn-outline-danger" id="delete-btn">删除</button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- Title and Processed Info/Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">{{ context.title or 'N/A' }}</h5>
            </div>
            <div class="card-body">
                <!-- Summary -->
                {% if context.summary %}
                <div class="mb-4">
                    <h6>总结</h6>
                    <p class="text-muted">{{ context.summary }}</p>
                </div>
                <hr>
                {% endif %}

                <!-- Processed Info -->
                <h6>处理后信息</h6>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>ID:</strong> <small class="text-muted">{{ context.id }}</small></li>
                    <li class="list-group-item"><strong>上下文类型:</strong> <span class="badge bg-primary">{{ context.context_type }}</span></li>
                    <li class="list-group-item"><strong>创建时间:</strong> <small class="text-muted">{{ context.create_time }}</small></li>
                    <li class="list-group-item"><strong>更新时间:</strong> <small class="text-muted">{{ context.update_time }}</small></li>
                    <li class="list-group-item"><strong>事件时间:</strong> <small class="text-muted">{{ context.event_time }}</small></li>
                    <li class="list-group-item"><strong>调用次数:</strong> <small class="text-muted">{{ context.call_count }}</small></li>
                    <li class="list-group-item"><strong>合并次数:</strong> <small class="text-muted">{{ context.merge_count }}</small></li>
                    <li class="list-group-item"><strong>持续次数:</strong> <small class="text-muted">{{ context.duration_count }}</small></li>
                    <li class="list-group-item"><strong>置信度:</strong> <small class="text-muted">{{ context.confidence }}</small></li>
                    <li class="list-group-item"><strong>重要性:</strong> <small class="text-muted">{{ context.importance }}</small></li>
                    <li class="list-group-item"><strong>是否发生:</strong> <small class="text-muted">{{ context.is_happened }}</small></li>
                    <li class="list-group-item"><strong>允许合并:</strong> <small class="text-muted">{{ context.enable_merge }}</small></li>
                    <li class="list-group-item"><strong>合并次数:</strong> <small class="text-muted">{{ context.merge_count }}</small></li>
                    <li class="list-group-item"><strong>最后调用时间:</strong> <small class="text-muted">{{ context.last_call_time or 'N/A' }}</small></li>
                    {% if context.user_id %}
                    <li class="list-group-item"><strong>User ID:</strong> <small class="text-muted">{{ context.user_id }}</small></li>
                    {% endif %}
                    {% if context.device_id %}
                    <li class="list-group-item"><strong>Device ID:</strong> <small class="text-muted">{{ context.device_id }}</small></li>
                    {% endif %}
                    {% if context.agent_id %}
                    <li class="list-group-item"><strong>Agent ID:</strong> <small class="text-muted">{{ context.agent_id }}</small></li>
                    {% endif %}
                </ul>
                {% if context.entities %}
                <hr>
                <h6>实体</h6>
                <p>
                    {% for entity in context.entities %}
                        <span class="badge bg-info">{{ entity }}</span>
                    {% endfor %}
                </p>
                {% endif %}
                {% if context.metadata %}
                <hr>
                <h6>元数据</h6>
                <ul class="list-group list-group-flush">
                    {% for key, value in context.metadata.items() %}
                        <li class="list-group-item">
                            <strong>{{ key }}:</strong> 
                            {% if value is mapping %}
                                <pre class="mb-0 bg-light p-2 rounded">{{ value | tojson(indent=2) }}</pre>
                            {% elif value is iterable and value is not string %}
                                <div>
                                    {% for item in value %}
                                        <span class="badge bg-secondary">{{ item }}</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <small class="text-muted">{{ value }}</small>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
                {% endif %}
                <hr>
                <h6>Keywords</h6>
                <p>
                    {% if context.keywords %}
                        {% for keyword in context.keywords %}
                            <span class="badge bg-secondary">{{ keyword }}</span>
                        {% endfor %}
                    {% else %}
                        <small class="text-muted">No keywords.</small>
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- Event Hierarchy Tree (only for event type) -->
        {% if context.context_type == 'event' %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="d-flex align-items-center mb-0">
                    事件层级结构
                    {% set level_colors = {0: 'info', 1: 'success', 2: 'warning', 3: 'danger'} %}
                    <span class="badge bg-{{ level_colors.get(context.hierarchy_level, 'secondary') }} ms-2">L{{ context.hierarchy_level }}</span>
                    {% if context.hierarchy_level == 0 %}<small class="text-muted ms-1">原始事件</small>
                    {% elif context.hierarchy_level == 1 %}<small class="text-muted ms-1">日摘要</small>
                    {% elif context.hierarchy_level == 2 %}<small class="text-muted ms-1">周摘要</small>
                    {% elif context.hierarchy_level == 3 %}<small class="text-muted ms-1">月摘要</small>
                    {% endif %}
                </h6>
            </div>
            <div class="card-body">
                <!-- Time bucket -->
                {% if context.time_bucket %}
                <div class="mb-3">
                    <strong>时间桶:</strong> <span class="badge bg-secondary">{{ context.time_bucket }}</span>
                </div>
                {% endif %}

                <!-- Parent node link -->
                {% if context.parent_id %}
                <div class="mb-3">
                    <strong>父节点:</strong>
                    <a href="#" onclick="viewContext('{{ context.parent_id }}', 'event')" class="text-decoration-none">
                        <span class="badge bg-outline-primary border border-primary text-primary">{{ context.parent_id[:12] }}...</span>
                    </a>
                    <span id="parent-title" class="text-muted ms-1"></span>
                </div>
                {% endif %}

                <!-- Children tree -->
                {% if context.children_ids and context.children_ids|length > 0 %}
                <div class="mt-3">
                    <h6>子节点 <span class="badge bg-secondary">{{ context.children_ids|length }}</span></h6>
                    <div id="children-tree">
                        <div class="text-center p-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <small class="text-muted ms-2">加载子节点...</small>
                        </div>
                    </div>
                </div>
                {% elif context.hierarchy_level == 0 %}
                <div class="text-muted"><small>L0 原始事件，无子节点</small></div>
                {% else %}
                <div class="text-muted"><small>暂无子节点</small></div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Raw Data -->
        <div class="card mb-4">
            <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" href="#raw-data-collapse" role="button" aria-expanded="false" aria-controls="raw-data-collapse">
                <h6 class="d-flex justify-content-between align-items-center mb-0">
                    原始数据
                    <i class="fas fa-chevron-down"></i>
                </h6>
            </div>
            <div class="collapse" id="raw-data-collapse">
                <div class="card-body">
                    {% if context.raw_contexts %}
                        {% for raw_context in context.raw_contexts %}
                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>Object ID:</strong> <small class="text-muted">{{ raw_context.object_id }}</small>
                            </div>
                            <div class="card-body">
                                {% if raw_context.content_format == 'image' and raw_context.content_path %}
                                    <img src="/files/{{ raw_context.content_path }}" class="img-fluid rounded" alt="Image">
                                {% elif raw_context.content_format == 'video' and raw_context.content_path %}
                                    <video controls class="img-fluid rounded">
                                        <source src="/files/{{ raw_context.content_path }}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                {% elif raw_context.content_text is mapping %}
                                    <pre class="content-pre bg-light p-3 rounded">{{ raw_context.content_text | tojson(indent=2) }}</pre>
                                {% elif raw_context.content_text is string and (raw_context.content_text.strip().startswith('{') or raw_context.content_text.strip().startswith('[')) %}
                                    <pre class="content-pre bg-light p-3 rounded">{{ raw_context.content_text | tojson(indent=2) }}</pre>
                                {% else %}
                                    <pre class="content-pre bg-light p-3 rounded">{{ raw_context.content_text }}</pre>
                                {% endif %}
                            </div>
                            <div class="card-footer">
                                <h6>元数据</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item"><strong>类型:</strong> <span class="badge bg-info">{{ raw_context.source }}</span></li>
                                    <li class="list-group-item"><strong>数据类型:</strong> <span class="badge bg-success">{{ raw_context.content_format }}</span></li>
                                    <li class="list-group-item"><strong>创建时间:</strong> <small class="text-muted">{{ raw_context.create_time }}</small></li>
                                </ul>
                                {% if raw_context.additional_info %}
                                <hr>
                                <h6>Additional Info</h6>
                                <ul class="list-group list-group-flush">
                                    {% for key, value in raw_context.additional_info.items() %}
                                        <li class="list-group-item"><strong>{{ key }}:</strong> <small class="text-muted">{{ value }}</small></li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">没有原始数据。</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .content-pre, .metadata-pre {
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 600px;
        overflow-y: auto;
    }
    .tree-node {
        border-left: 2px solid #dee2e6;
        padding-left: 16px;
        margin-left: 8px;
    }
    .tree-item {
        position: relative;
        padding: 8px 12px;
        margin-bottom: 4px;
        border-radius: 6px;
        background: #f8f9fa;
        transition: background 0.15s;
    }
    .tree-item:hover {
        background: #e9ecef;
    }
    .tree-item::before {
        content: '';
        position: absolute;
        left: -18px;
        top: 16px;
        width: 12px;
        height: 0;
        border-top: 2px solid #dee2e6;
    }
    .tree-toggle {
        cursor: pointer;
        user-select: none;
    }
    .tree-toggle .bi {
        transition: transform 0.2s;
    }
    .tree-toggle.expanded .bi {
        transform: rotate(90deg);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const LEVEL_COLORS = {0: 'info', 1: 'success', 2: 'warning', 3: 'danger'};
    const LEVEL_LABELS = {0: '原始事件', 1: '日摘要', 2: '周摘要', 3: '月摘要'};

    // Cache loaded contexts to avoid duplicate fetches
    const contextCache = {};

    async function fetchContext(contextId) {
        if (contextCache[contextId]) return contextCache[contextId];
        try {
            const response = await fetch(`/api/contexts/${contextId}?context_type=event`);
            if (!response.ok) return null;
            const data = await response.json();
            contextCache[contextId] = data;
            return data;
        } catch (e) {
            console.error('Failed to fetch context:', contextId, e);
            return null;
        }
    }

    function renderTreeItem(ctx) {
        const level = ctx.hierarchy_level || 0;
        const color = LEVEL_COLORS[level] || 'secondary';
        const hasChildren = ctx.children_ids && ctx.children_ids.length > 0;
        const childCount = hasChildren ? ctx.children_ids.length : 0;

        return `
            <div class="tree-item" data-id="${ctx.id}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        ${hasChildren ? `<span class="tree-toggle me-1" onclick="toggleChildren(this, '${ctx.id}')"><i class="bi bi-chevron-right"></i></span>` : '<span class="me-3"></span>'}
                        <span class="badge bg-${color} me-1">L${level}</span>
                        <a href="#" onclick="viewContext('${ctx.id}', 'event')" class="text-decoration-none fw-semibold">${ctx.title || '未命名'}</a>
                        ${hasChildren ? `<span class="badge bg-secondary ms-1">${childCount}</span>` : ''}
                        ${ctx.time_bucket ? `<small class="text-muted ms-2">${ctx.time_bucket}</small>` : ''}
                    </div>
                </div>
                ${ctx.summary ? `<div class="text-muted small mt-1 ms-4">${ctx.summary.substring(0, 120)}${ctx.summary.length > 120 ? '...' : ''}</div>` : ''}
                ${hasChildren ? `<div class="tree-node d-none" id="children-of-${ctx.id}"></div>` : ''}
            </div>
        `;
    }

    async function toggleChildren(toggleEl, parentId) {
        const container = document.getElementById(`children-of-${parentId}`);
        const isExpanded = toggleEl.classList.contains('expanded');

        if (isExpanded) {
            container.classList.add('d-none');
            toggleEl.classList.remove('expanded');
            return;
        }

        toggleEl.classList.add('expanded');
        container.classList.remove('d-none');

        // If already loaded, just show
        if (container.dataset.loaded === 'true') return;

        container.innerHTML = '<div class="text-center p-2"><div class="spinner-border spinner-border-sm"></div></div>';

        const parent = contextCache[parentId];
        if (!parent || !parent.children_ids) return;

        const children = await Promise.all(parent.children_ids.map(id => fetchContext(id)));
        const validChildren = children.filter(c => c !== null);

        if (validChildren.length === 0) {
            container.innerHTML = '<div class="text-muted small p-2">无法加载子节点</div>';
        } else {
            container.innerHTML = validChildren.map(c => renderTreeItem(c)).join('');
        }
        container.dataset.loaded = 'true';
    }

    async function viewContext(contextId, contextType) {
        try {
            const response = await fetch('/contexts/detail', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: contextId, context_type: contextType})
            });
            if (response.ok) {
                const html = await response.text();
                document.open();
                document.write(html);
                document.close();
            } else {
                alert('查看失败');
            }
        } catch (error) {
            console.error('查看操作失败:', error);
            alert('查看操作失败');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Delete button
        document.getElementById('delete-btn').addEventListener('click', async function() {
            if (confirm('确定要删除这个上下文吗？此操作不可撤销。')) {
                try {
                    const response = await fetch(`/api/contexts/{{ context.id }}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        window.location.href = '/contexts';
                    } else {
                        const error = await response.json();
                        alert(`删除失败: ${error.detail || '未知错误'}`);
                    }
                } catch (error) {
                    console.error('删除操作失败:', error);
                    alert('删除操作失败，请查看控制台获取详细信息。');
                }
            }
        });

        {% if context.context_type == 'event' %}
        // Load parent title
        {% if context.parent_id %}
        (async () => {
            const parent = await fetchContext('{{ context.parent_id }}');
            if (parent) {
                document.getElementById('parent-title').textContent = parent.title || '';
            }
        })();
        {% endif %}

        // Load children tree
        {% if context.children_ids and context.children_ids|length > 0 %}
        (async () => {
            const childrenIds = {{ context.children_ids | tojson }};
            const treeContainer = document.getElementById('children-tree');

            // Cache current context for toggleChildren
            contextCache['{{ context.id }}'] = {
                id: '{{ context.id }}',
                children_ids: childrenIds,
                hierarchy_level: {{ context.hierarchy_level }},
                title: {{ (context.title or '') | tojson }},
                summary: {{ (context.summary or '') | tojson }}
            };

            const children = await Promise.all(childrenIds.map(id => fetchContext(id)));
            const validChildren = children.filter(c => c !== null);

            if (validChildren.length === 0) {
                treeContainer.innerHTML = '<div class="text-muted">无法加载子节点</div>';
            } else {
                treeContainer.innerHTML = validChildren.map(c => renderTreeItem(c)).join('');
            }
        })();
        {% endif %}
        {% endif %}
    });
</script>
{% endblock %}
        